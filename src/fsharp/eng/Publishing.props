<Project>
  <PropertyGroup>
    <PublishingVersion>3</PublishingVersion>
    <PublishDependsOnTargets>$(PublishDependsOnTargets);_PublishPackages</PublishDependsOnTargets>
  </PropertyGroup>

  <ItemGroup>
    <_PackagesToPublish Remove="@(_PackagesToPublish)" />
    <_PackagesToPublish Include="$(ArtifactsPackagesDir)**\*.tar.gz" UploadPathSegment="Runtime" Condition="'$(ArcadeBuildFromSource)' == 'true'" />
    <_PackagesToPublish Include="$(ArtifactsPackagesDir)**\*.nupkg" UploadPathSegment="Runtime" Condition="'$(ArcadeBuildFromSource)' == 'true'" />
  </ItemGroup>

  <Target Name="_PublishPackages">
    <ItemGroup>
      <!-- Do not push .nupkg files from Linux and macOS builds. They'll be packed up separately and signed on Windows.
           Do not remove if post build sign is true, as we avoid the xplat codesign jobs, and need to have
           the nupkgs pushed. Do not do this if building from source, since we want the source build intermediate package
           to be published. Use ArcadeBuildFromSource as DotNetBuildFromSource is only set in the internal source build,
           and Build.proj is invoked from the wrapper build. -->
      <ItemsToPushToBlobFeed Remove="@(ItemsToPushToBlobFeed)" Condition="'$(OS)' != 'Windows_NT' and '$(PostBuildSign)' != 'true' and '$(ArcadeBuildFromSource)' != 'true'" />

      <ItemsToPushToBlobFeed Include="@(_PackagesToPublish)">
        <ManifestArtifactData>NonShipping=false</ManifestArtifactData>
        <PublishFlatContainer>true</PublishFlatContainer>
        <RelativeBlobPath>$(_UploadPathRoot)/%(_PackagesToPublish.UploadPathSegment)/$(_PackageVersion)/%(Filename)%(Extension)</RelativeBlobPath>
      </ItemsToPushToBlobFeed>
    </ItemGroup>
  </Target>

</Project>
